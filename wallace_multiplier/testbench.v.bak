`timescale 1ns/1ps

module testbench;

    // --- 1. KHAI BÁO TÍN HIỆU ---
    reg clk;
    reg rst_n;
    reg valid_in;
    reg signed [3:0] A, B;
    
    wire valid_out;
    wire signed [7:0] P;

    // Biến thống kê lỗi
    integer error_count = 0;
    integer test_count = 0;

    // --- 2. KẾT NỐI MODULE (DUT) ---
    wallace_multiplier_pro dut (
        .clk(clk),
        .rst_n(rst_n),
        .valid_in(valid_in),
        .valid_out(valid_out),
        .A(A),
        .B(B),
        .P(P)
    );

    // --- 3. TẠO XUNG NHỊP (CLOCK GENERATION) ---
    initial begin
        clk = 0;
        forever #5 clk = ~clk; // Chu kỳ 10ns (100MHz)
    end

    // --- 4. MÔ HÌNH THAM CHIẾU (GOLDEN MODEL & PIPELINE DELAY) ---
    // Vì DUT mất 2 nhịp để tính toán, Testbench cũng phải "nhớ" Input 
    // của 2 nhịp trước để so sánh kết quả.
    
    reg signed [3:0] A_d1, B_d1; // Delay 1 nhịp
    reg signed [3:0] A_d2, B_d2; // Delay 2 nhịp (Input tương ứng với Output P hiện tại)
    reg signed [7:0] expected_P; // Kết quả mong đợi

    always @(posedge clk or negedge rst_n) begin
        if (!rst_n) begin
            A_d1 <= 0; B_d1 <= 0;
            A_d2 <= 0; B_d2 <= 0;
        end else begin
            // Shift Register để tạo độ trễ 2 chu kỳ
            if (valid_in) begin
                A_d1 <= A; 
                B_d1 <= B;
                
                A_d2 <= A_d1;
                B_d2 <= B_d1;
            end
        end
    end

    // Tính toán kết quả mong đợi từ Input đã bị trễ 2 nhịp
    assign expected_P = A_d2 * B_d2;

    // --- 5. TỰ ĐỘNG KIỂM TRA (CHECKER) ---
    always @(posedge clk) begin
        if (rst_n && valid_out) begin
            test_count = test_count + 1;
            
            // So sánh Output thực tế (P) với Output mong đợi (expected_P)
            if (P !== expected_P) begin
                $display("[FAIL] Time: %0t | Input: %d x %d | Expect: %d | Got: %d", 
                         $time, A_d2, B_d2, expected_P, P);
                error_count = error_count + 1;
            end else begin
                // Uncomment dòng dưới nếu muốn thấy chi tiết từng phép tính đúng
                // $display("[PASS] Time: %0t | Input: %d x %d = %d", $time, A_d2, B_d2, P);
            end
        end
    end

    // --- 6. KỊCH BẢN KIỂM TRA (STIMULUS) ---
    initial begin
        // A. Khởi tạo
        $display("=== BẮT ĐẦU MÔ PHỎNG ===");
        rst_n = 0; valid_in = 0; A = 0; B = 0;
        #15 rst_n = 1; // Thả Reset sau 15ns

        // B. Test Case 1: Số Dương x Số Dương
        @(posedge clk); drive_input(3, 2);
        @(posedge clk); drive_input(7, 1);
        @(posedge clk); drive_input(4, 4);

        // C. Test Case 2: Số Âm x Số Dương (Kiểm tra Baugh-Wooley)
        @(posedge clk); drive_input(-3, 2);  // -6
        @(posedge clk); drive_input(-8, 1);  // -8 (Min Value)
        @(posedge clk); drive_input(-4, 4);  // -16

        // D. Test Case 3: Số Dương x Số Âm
        @(posedge clk); drive_input(5, -2);  // -10
        @(posedge clk); drive_input(7, -8);  // -56

        // E. Test Case 4: Số Âm x Số Âm
        @(posedge clk); drive_input(-2, -3); // 6
        @(posedge clk); drive_input(-8, -8); // 64 (Max Negative Product) -> Cẩn thận tràn số? 
                                             // -8 * -8 = 64. Signed 8-bit max là 127. OK.

        // F. Test Case 5: Random Stress Test
        repeat (20) begin
            @(posedge clk);
            drive_input($random, $random); // Sinh số ngẫu nhiên 32-bit, tự cắt xuống 4-bit
        end

        // G. Test Case 6: Idle (Ngắt dữ liệu)
        @(posedge clk);
        valid_in = 0; A = 0; B = 0;
        
        // Chờ pipeline xả hết dữ liệu cũ (cần ít nhất 3 clock)
        #50;

        // --- 7. TỔNG KẾT ---
        $display("-------------------------------------------");
        if (error_count == 0) begin
            $display("MÔ PHỎNG THÀNH CÔNG! Đã kiểm tra %d trường hợp.", test_count);
            $display("Tuyệt vời! Code Baugh-Wooley Pipeline hoạt động chuẩn xác.");
        end else begin
            $display("MÔ PHỎNG THẤT BẠI! Có %d lỗi xảy ra.", error_count);
        end
        $display("-------------------------------------------");
        $finish;
    end

    // Task hỗ trợ lái tín hiệu cho gọn code
    task drive_input(input signed [3:0] inA, input signed [3:0] inB);
        begin
            valid_in <= 1;
            A <= inA;
            B <= inB;
        end
    endtask

endmodule